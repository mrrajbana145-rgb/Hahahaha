import os
import asyncio
import logging
import json
import random
import datetime
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler
)

# Bot Configuration
BOT_TOKEN = os.environ.get("BOT_TOKEN", "8509335052:AAH6ImNyRmhUUBVdQecl7wZqBF8omI2DiHA")
OWNER_ID = int(os.environ.get("OWNER_ID", 8560626884))

# Setup Logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

class Database:
    def __init__(self):
        self.users = {}
        self.load_data()
    
    def load_data(self):
        try:
            if os.path.exists("users.json"):
                with open("users.json", 'r') as f:
                    self.users = json.load(f)
        except:
            self.users = {}
    
    def save_data(self):
        try:
            with open("users.json", 'w') as f:
                json.dump(self.users, f, indent=2)
        except:
            pass
    
    def get_user(self, user_id: int):
        user_id_str = str(user_id)
        if user_id_str not in self.users:
            self.users[user_id_str] = {
                "balance": 9999 if user_id == OWNER_ID else 0,
                "credits": 0,
                "referrals": [],
                "referral_code": f"REF{user_id}",
                "history_requests": 0,
                "joined_channel": False,
                "created_at": datetime.now().strftime("%d/%m/%Y %H:%M"),
                "last_active": datetime.now().isoformat()
            }
            self.save_data()
        else:
            # Update last active
            self.users[user_id_str]["last_active"] = datetime.now().isoformat()
            self.save_data()
        
        # Ensure owner always has 9999 balance
        if user_id == OWNER_ID:
            self.users[user_id_str]["balance"] = 9999
            self.users[user_id_str]["joined_channel"] = True
        
        return self.users[user_id_str]
    
    def get_all_users(self):
        return self.users

db = Database()

# ========== KEYBOARDS ==========

def get_channel_keyboard():
    keyboard = [
        [InlineKeyboardButton("ğŸ“¢ Join Channel", url="https://t.me/+u2-7A1Ecq_tmMWY1")],
        [InlineKeyboardButton("âœ… I've Joined", callback_data="joined_channel")]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_main_menu():
    keyboard = [
        [InlineKeyboardButton("ğŸ“ Call History", callback_data="call_history")],
        [InlineKeyboardButton("ğŸ”’ History + Recording", callback_data="history_rc")],
        [InlineKeyboardButton("ğŸ“± Check Demo", url="https://t.me/callhistry")],
        [InlineKeyboardButton("ğŸ‘¥ Referral Program", callback_data="referral")],
        [InlineKeyboardButton("ğŸ’° Check Balance", callback_data="check_balance")],
        [InlineKeyboardButton("ğŸ’³ Add Funds", callback_data="add_funds")],
        [InlineKeyboardButton("ğŸ†˜ Contact Support", url="http://t.me/Tigertransportbot")]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_history_plans():
    keyboard = [
        [InlineKeyboardButton("ğŸ“ 1 Month - â‚¹600", callback_data="plan_history_1")],
        [InlineKeyboardButton("ğŸ“ 2 Months - â‚¹1200", callback_data="plan_history_2")],
        [InlineKeyboardButton("ğŸ“ 3 Months - â‚¹1800", callback_data="plan_history_3")],
        [InlineKeyboardButton("ğŸ”™ Back", callback_data="main_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_history_rc_plans():
    keyboard = [
        [InlineKeyboardButton("ğŸ”’ 1 Month + Recording - â‚¹600", callback_data="plan_rc_1")],
        [InlineKeyboardButton("ğŸ”’ 2 Months + Recording - â‚¹1200", callback_data="plan_rc_2")],
        [InlineKeyboardButton("ğŸ”’ 3 Months + Recording - â‚¹1500", callback_data="plan_rc_3")],
        [InlineKeyboardButton("ğŸ”™ Back", callback_data="main_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_admin_panel():
    keyboard = [
        [InlineKeyboardButton("ğŸ‘¥ Total Users", callback_data="admin_total_users")],
        [InlineKeyboardButton("ğŸ“¢ Broadcast All", callback_data="admin_broadcast")],
        [InlineKeyboardButton("ğŸ¯ Target Broadcast", callback_data="admin_target_broadcast")],
        [InlineKeyboardButton("ğŸ“Š Statistics", callback_data="admin_stats")],
        [InlineKeyboardButton("ğŸ”™ Main Menu", callback_data="main_menu")]
    ]
    return InlineKeyboardMarkup(keyboard)

# ========== COMMAND HANDLERS ==========

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /start command"""
    user = update.effective_user
    user_data = db.get_user(user.id)
    
    # Check referral code
    if context.args:
        ref_code = context.args[0]
        if ref_code.startswith("REF") and ref_code != user_data["referral_code"]:
            try:
                ref_id = int(ref_code[3:])
                if ref_id != user.id:
                    # Add referral
                    ref_user = db.get_user(ref_id)
                    ref_user["credits"] += 1
                    ref_user["referrals"].append(user.id)
                    user_data["referred_by"] = ref_id
                    db.save_data()
            except:
                pass
    
    # Owner gets direct access
    if user.id == OWNER_ID:
        await update.message.reply_text(
            f"ğŸ‘‘ **OWNER PANEL**\n\n"
            f"Balance: â‚¹9999\n"
            f"Total Users: {len(db.get_all_users())}",
            reply_markup=get_main_menu(),
            parse_mode='Markdown'
        )
        return
    
    # Check channel join for normal users
    if not user_data["joined_channel"]:
        await update.message.reply_text(
            "ğŸ”’ **CHANNEL VERIFICATION REQUIRED**\n\n"
            "Please join our channel to access services:",
            reply_markup=get_channel_keyboard(),
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text(
            f"ğŸ‘‹ **Welcome {user.first_name}!**\n\n"
            "Premium Call History Services\n"
            "Select from menu below:",
            reply_markup=get_main_menu(),
            parse_mode='Markdown'
        )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /help command"""
    await update.message.reply_text(
        "ğŸ†˜ **HELP & SUPPORT**\n\n"
        "ğŸ“ Support: @Tigertransportbot\n"
        "ğŸ“¢ Channel: @callhistry\n\n"
        "ğŸ’³ **Payment Issues:**\n"
        "â€¢ Contact support with UTR\n"
        "â€¢ Share payment screenshot\n"
        "â€¢ Wait for verification\n\n"
        "â° Response: 2-12 hours",
        parse_mode='Markdown'
    )

async def admin_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /admin command"""
    if update.effective_user.id == OWNER_ID:
        await update.message.reply_text(
            "ğŸ” **ADMIN PANEL**\n\n"
            "Select option:",
            reply_markup=get_admin_panel(),
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text("â›” Access Denied")

# ========== BUTTON HANDLERS ==========

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle button clicks"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    data = query.data
    
    # Channel join
    if data == "joined_channel":
        user = db.get_user(user_id)
        user["joined_channel"] = True
        db.save_data()
        
        await query.edit_message_text(
            "âœ… **ACCESS GRANTED**\n\n"
            "You can now use all services!",
            reply_markup=get_main_menu(),
            parse_mode='Markdown'
        )
        return
    
    # Main menu
    if data == "main_menu":
        await query.edit_message_text(
            "ğŸ“ **MAIN MENU**",
            reply_markup=get_main_menu(),
            parse_mode='Markdown'
        )
        return
    
    # Check channel for normal users
    user_data = db.get_user(user_id)
    if user_id != OWNER_ID and not user_data["joined_channel"]:
        await query.edit_message_text(
            "ğŸ”’ Join channel first!",
            reply_markup=get_channel_keyboard(),
            parse_mode='Markdown'
        )
        return
    
    # Call History plans
    if data == "call_history":
        await query.edit_message_text(
            "ğŸ“ **CALL HISTORY PLANS**\n\n"
            "â€¢ 1 Month: â‚¹600\n"
            "â€¢ 2 Months: â‚¹1200\n"
            "â€¢ 3 Months: â‚¹1800\n\n"
            "All reports include 150+ unique numbers",
            reply_markup=get_history_plans(),
            parse_mode='Markdown'
        )
        return
    
    # History + Recording plans
    elif data == "history_rc":
        await query.edit_message_text(
            "ğŸ”’ **HISTORY + RECORDING**\n\n"
            "Premium package includes:\n"
            "â€¢ Complete call history\n"
            "â€¢ Advanced analysis\n"
            "â€¢ Secure delivery",
            reply_markup=get_history_rc_plans(),
            parse_mode='Markdown'
        )
        return
    
    # Check Balance
    elif data == "check_balance":
        user = db.get_user(user_id)
        await query.edit_message_text(
            f"ğŸ’° **ACCOUNT BALANCE**\n\n"
            f"â€¢ Balance: â‚¹{user['balance']}\n"
            f"â€¢ Credits: {user['credits']}\n"
            f"â€¢ Requests: {user['history_requests']}\n\n"
            f"ğŸ’³ **Deposit Range:**\n"
            f"Min: â‚¹600 | Max: â‚¹10,000\n\n"
            f"ğŸ‘¥ **Referral Progress:**\n"
            f"{user['credits']}/100 credits",
            reply_markup=get_main_menu(),
            parse_mode='Markdown'
        )
        return
    
    # Referral Program
    elif data == "referral":
        user = db.get_user(user_id)
        await query.edit_message_text(
            f"ğŸ‘¥ **REFERRAL PROGRAM**\n\n"
            f"Your Code: `{user['referral_code']}`\n\n"
            f"Share: https://t.me/Callhistorypaidbot?start={user['referral_code']}\n\n"
            f"â€¢ Each referral: 1 credit\n"
            f"â€¢ 100 credits: 50% discount\n\n"
            f"Your credits: {user['credits']}",
            reply_markup=get_main_menu(),
            parse_mode='Markdown'
        )
        return
    
    # Add Funds
    elif data == "add_funds":
        context.user_data['state'] = 'waiting_amount'
        await query.edit_message_text(
            "ğŸ’³ **ADD FUNDS**\n\n"
            "Enter amount (â‚¹600-â‚¹10000):\n\n"
            "Example: `600` or `1200`",
            parse_mode='Markdown'
        )
        return
    
    # Plan selection
    elif data.startswith("plan_"):
        plan_map = {
            "history_1": {"price": 600, "days": 30, "name": "1 Month Call History"},
            "history_2": {"price": 1200, "days": 60, "name": "2 Months Call History"},
            "history_3": {"price": 1800, "days": 90, "name": "3 Months Call History"},
            "rc_1": {"price": 600, "days": 30, "name": "1 Month + Recording"},
            "rc_2": {"price": 1200, "days": 60, "name": "2 Months + Recording"},
            "rc_3": {"price": 1500, "days": 90, "name": "3 Months + Recording"}
        }
        
        plan_key = data[5:]
        if plan_key in plan_map:
            plan = plan_map[plan_key]
            user = db.get_user(user_id)
            
            # Check balance (owner gets free)
            if user["balance"] < plan["price"] and user_id != OWNER_ID:
                await query.edit_message_text(
                    f"âŒ **INSUFFICIENT BALANCE**\n\n"
                    f"Required: â‚¹{plan['price']}\n"
                    f"Your balance: â‚¹{user['balance']}\n\n"
                    "Please add funds first.",
                    reply_markup=InlineKeyboardMarkup([[
                        InlineKeyboardButton("ğŸ’³ Add Funds", callback_data="add_funds"),
                        InlineKeyboardButton("ğŸ”™ Back", callback_data="history_rc" if "rc" in plan_key else "call_history")
                    ]]),
                    parse_mode='Markdown'
                )
                return
            
            # Store plan in context
            context.user_data['selected_plan'] = plan_key
            context.user_data['plan_price'] = plan["price"]
            context.user_data['plan_days'] = plan["days"]
            context.user_data['state'] = 'waiting_number'
            
            await query.edit_message_text(
                f"âœ… **PLAN SELECTED**\n\n"
                f"Service: {plan['name']}\n"
                f"Price: â‚¹{plan['price']}\n"
                f"Duration: {plan['days']} days\n\n"
                f"ğŸ“± **Enter target number:**\n"
                f"Format: +91XXXXXXXXXX\n\n"
                f"Example: +919876543210",
                parse_mode='Markdown'
            )
    
    # Admin panel options
    elif user_id == OWNER_ID and data.startswith("admin_"):
        if data == "admin_panel":
            await query.edit_message_text(
                "ğŸ” **ADMIN PANEL**",
                reply_markup=get_admin_panel(),
                parse_mode='Markdown'
            )
        
        elif data == "admin_total_users":
            all_users = db.get_all_users()
            user_list = []
            for uid, user_data in all_users.items():
                user_list.append(f"ID: {uid} | Balance: â‚¹{user_data['balance']}")
            
            user_text = "\n".join(user_list[:50])  # First 50 users
            if len(user_list) > 50:
                user_text += f"\n\n... and {len(user_list)-50} more users"
            
            await query.edit_message_text(
                f"ğŸ‘¥ **TOTAL USERS: {len(all_users)}**\n\n{user_text}",
                reply_markup=get_admin_panel(),
                parse_mode='Markdown'
            )
        
        elif data == "admin_stats":
            all_users = db.get_all_users()
            total_balance = sum(u["balance"] for u in all_users.values())
            total_requests = sum(u["history_requests"] for u in all_users.values())
            
            await query.edit_message_text(
                f"ğŸ“Š **STATISTICS**\n\n"
                f"â€¢ Total Users: {len(all_users)}\n"
                f"â€¢ Total Balance: â‚¹{total_balance}\n"
                f"â€¢ Total Requests: {total_requests}\n"
                f"â€¢ Owner Balance: â‚¹9999\n"
                f"â€¢ Updated: {datetime.now().strftime('%H:%M')}",
                reply_markup=get_admin_panel(),
                parse_mode='Markdown'
            )

# ========== MESSAGE HANDLERS ==========

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle all text messages"""
    user_id = update.effective_user.id
    text = update.message.text.strip()
    state = context.user_data.get('state', '')
    
    # Handle deposit amount
    if state == 'waiting_amount':
        try:
            amount = int(text)
            if amount < 600 or amount > 10000:
                await update.message.reply_text("âŒ Amount must be â‚¹600-â‚¹10000")
                return
            
            context.user_data['deposit_amount'] = amount
            context.user_data['state'] = 'waiting_utr'
            
            await update.message.reply_photo(
                photo="https://i.postimg.cc/x1XJXfzb/Screenshot-2025-09-12-22-15-49-26-4336b74596784d9a2aa81f87c2016f50.jpg",
                caption=f"âœ… **DEPOSIT REQUEST**\n\n"
                       f"Amount: â‚¹{amount}\n"
                       f"Date: {datetime.now().strftime('%d/%m/%Y %H:%M')}\n\n"
                       f"1. Scan QR code\n"
                       f"2. Send exact amount\n"
                       f"3. Share UTR number",
                parse_mode='Markdown'
            )
            
            await update.message.reply_text(
                "ğŸ“ **ENTER UTR NUMBER**\n\n"
                "Send UTR (12+ characters):\n"
                "Example: `HDFC2401121530456789`",
                parse_mode='Markdown'
            )
            
        except ValueError:
            await update.message.reply_text("âŒ Invalid amount. Enter numbers only.")
    
    # Handle UTR input
    elif state == 'waiting_utr':
        if len(text) < 12:
            await update.message.reply_text("âŒ UTR must be 12+ characters")
            return
        
        # Always show payment not received
        await update.message.reply_text(
            f"âŒ **PAYMENT NOT RECEIVED**\n\n"
            f"UTR: `{text[:20]}...`\n"
            f"Status: NOT VERIFIED\n"
            f"Time: {datetime.now().strftime('%H:%M:%S')}\n\n"
            f"ğŸ†˜ **CONTACT SUPPORT:**\n"
            f"@Tigertransportbot\n\n"
            f"Please provide:\n"
            f"1. Payment screenshot\n"
            f"2. UTR number\n"
            f"3. Transaction details",
            parse_mode='Markdown',
            reply_markup=InlineKeyboardMarkup([[
                InlineKeyboardButton("ğŸ†˜ Contact Support", url="http://t.me/Tigertransportbot"),
                InlineKeyboardButton("ğŸ  Main Menu", callback_data="main_menu")
            ]])
        )
        
        # Notify owner
        try:
            await context.bot.send_message(
                OWNER_ID,
                f"ğŸ’¸ PAYMENT ATTEMPT\n"
                f"User: @{update.effective_user.username} ({user_id})\n"
                f"Amount: â‚¹{context.user_data.get('deposit_amount', 0)}\n"
                f"UTR: {text}\n"
                f"Time: {datetime.now().strftime('%H:%M')}"
            )
        except:
            pass
        
        context.user_data.clear()
    
    # Handle target number for history
    elif state == 'waiting_number':
        # Validate number format
        if not text.startswith('+91') or len(text) != 13 or not text[3:].isdigit():
            await update.message.reply_text(
                "âŒ **INVALID FORMAT**\n\n"
                "Use: +91XXXXXXXXXX\n"
                "Example: +919876543210\n\n"
                "Enter again:",
                parse_mode='Markdown'
            )
            return
        
        user = db.get_user(user_id)
        plan_price = context.user_data.get('plan_price', 0)
        
        # Apply discount for 100 credits
        discount = 0
        if user["credits"] >= 100 and user_id != OWNER_ID:
            discount = plan_price // 2
            user["credits"] -= 100
        
        # Owner gets free
        if user_id == OWNER_ID:
            discount = plan_price
        
        final_price = plan_price - discount
        
        # Check balance
        if user["balance"] < final_price and user_id != OWNER_ID:
            await update.message.reply_text(
                f"âŒ **INSUFFICIENT BALANCE**\n\n"
                f"Required: â‚¹{final_price}\n"
                f"Your balance: â‚¹{user['balance']}",
                reply_markup=get_main_menu(),
                parse_mode='Markdown'
            )
            context.user_data.clear()
            return
        
        # Deduct balance (except owner)
        if user_id != OWNER_ID:
            user["balance"] -= final_price
        
        user["history_requests"] += 1
        db.save_data()
        
        # Generate fake history
        report = generate_fake_history(text, context.user_data.get('plan_days', 30))
        
        # Send report
        await update.message.reply_text(report, parse_mode='Markdown')
        
        # Send confirmation
        confirm_msg = f"""
âœ… **REPORT GENERATED**

ğŸ“‹ Details:
â€¢ Target: {text}
â€¢ Period: {context.user_data.get('plan_days', 30)} days

ğŸ’° Payment:"""
        
        if user_id == OWNER_ID:
            confirm_msg += "\nâ€¢ Owner: Free Service"
        elif discount > 0:
            confirm_msg += f"\nâ€¢ Discount: â‚¹{discount}\nâ€¢ Paid: â‚¹{final_price}"
        else:
            confirm_msg += f"\nâ€¢ Paid: â‚¹{final_price}"

        
